package com.bluepal.controller;

import com.bluepal.dto.CandidateResultDTO;
import com.bluepal.dto.ElectionResultDTO;
import com.bluepal.entity.Candidate;
import com.bluepal.entity.Election;
import com.bluepal.entity.Vote;
import com.bluepal.service.impl.CandidateServiceImpl;
import com.bluepal.service.impl.ElectionServiceImpl;
import com.bluepal.service.impl.VoteServiceImpl;

import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

import java.time.LocalDateTime;
import java.util.List;
import java.util.stream.Collectors;

@RestController
@RequestMapping("/api/results")
@RequiredArgsConstructor
public class VoterResultsController {

    private final VoteServiceImpl voteService;
    private final CandidateServiceImpl candidateService;
    private final ElectionServiceImpl electionService;

    // Get results for a specific election (after election ends)
    @GetMapping("/election/{electionId}")
    public ElectionResultDTO getElectionResults(@PathVariable Long electionId) {
        Election election = electionService.findById(electionId)
                .orElseThrow(() -> new RuntimeException("Election not found"));

        // Restrict voters from seeing results before election ends
        if (LocalDateTime.now().isBefore(election.getEndDate())) {
            throw new RuntimeException("Results not available until the election ends");
        }

        List<Candidate> candidates = candidateService.findByElection(election);
        List<Vote> votes = voteService.findByElection(election);
        long totalVotes = votes.size();

        List<CandidateResultDTO> candidateResults = candidates.stream().map(c -> {
            long voteCount = votes.stream().filter(v -> v.getCandidate().getId().equals(c.getId())).count();
            double percentage = totalVotes == 0 ? 0 : ((double) voteCount / totalVotes) * 100;
            return new CandidateResultDTO(c.getId(), c.getName(), c.getParty().getName(), voteCount, percentage);
        }).sorted((a, b) -> Long.compare(b.getVoteCount(), a.getVoteCount()))
          .collect(Collectors.toList());

        CandidateResultDTO winner = candidateResults.isEmpty() ? null : candidateResults.get(0);

        return new ElectionResultDTO(
                election.getId(),
                election.getTitle(),
                election.getStartDate(),
                election.getEndDate(),
                totalVotes,
                candidateResults,
                winner
        );
    }
}
